#!/bin/sh
# shellcheck shell=sh
set -eu

### FUNCTIONS

usage()
(
	t='  ' # two-space indentation to not collide with here-string indentation
	util_name=$(basename "$0")
	cat <<- EOF
		USAGE:
		${t}${util_name} PROG_NAME MSG_MAX

		ARGUMENTS:
		${t}PROG_NAME
		${t}${t}The name of the program for which logs are being rendered.
		${t}${t}This will be used as the notification ID and title (prettified).

		${t}MSG_MAX
		${t}${t}The maximum number of most recent lines to retain in the notification.
	EOF
)

### ENTRYPOINT

if [ $# -lt 2 ]; then
	usage >&2
	exit 1
fi

prog_name="$1" && shift
msg_max="$1" && shift

awk \
	-v msg_max="$msg_max" \
	-v prog_name="$prog_name" \
	-v bs=\\ \
	-v sq=\' \
	"$(
		cat <<- 'AWK'
			function esc(text) { gsub(sq, sq bs sq sq, text); return sq text sq }

			function show_all_logs_cmd(_cmd) {
				_cmd = "termux-dialog confirm"
				_cmd = _cmd" -t "esc(prog_label" - All Logs")
				content = all_msgs[0]
				for(idx = 1; idx < all_msgs_count; idx++) {
					content = content"\n"all_msgs[idx]
				}
				_cmd = _cmd" -i "esc(content)
				return _cmd
			}

			BEGIN {
				prog_label = prog_name
				gsub("-", " ", prog_label)
				# ---
				msg_tail = -1 #; msgs = []
				# all_msgs = []; all_msgs_count = 0
			}

			{
				msg_tail = (msg_tail + 1) % msg_max
				msgs[msg_tail] = $0
				all_msgs[all_msgs_count++] = $0

				msg_head = (msg_tail + 1) % msg_max
				content = msgs[msg_head]
				for(idx = (msg_head + 1) % msg_max; idx != msg_head; idx = (idx + 1) % msg_max) {
					content = content"\n"msgs[idx]
				}

				cmd = "termux-notification"
				cmd = cmd" --ongoing"
				cmd = cmd" --alert-once"
				cmd = cmd" --action "esc(show_all_logs_cmd())
				cmd = cmd" --id "esc(prog_name)
				cmd = cmd" --title "esc(prog_label)
				cmd = cmd" --content "esc(content)
				system(cmd)
			}

			END {
				msg_head = (msg_tail + 1) % msg_max
				content = msgs[msg_head]
				for(idx = (msg_head + 1) % msg_max; idx != msg_head; idx = (idx + 1) % msg_max) {
					content = content"\n"msgs[idx]
				}

				cmd = "termux-notification"
				cmd = cmd" --alert-once"
				cmd = cmd" --action "esc(show_all_logs_cmd())
				cmd = cmd" --id "esc(prog_name)
				cmd = cmd" --title "esc(prog_label)
				cmd = cmd" --content "esc(content)
				system(cmd)
			}
		AWK
	)" \
	;
