#!/bin/sh
# shellcheck shell=bash
[ "${BASH_VERSION-}" ] || exec bash "$0" "$@"
set -euo pipefail

# UTILITIES

tell_info()
{
	echo "INFO: $*" >&2
}

# has_util UTILITIES...
#
# Check if the specified utilities are available in the PATH.
# Exits with 0 if all utilities are found, 1 otherwise.
# If something is missing, stdout will list each missing utility per line.
#
# OUTPUT ::= "" | MISSING_UTILITY "\n" OUTPUT
has_util() (
	something_missing=
	for util; do
		shift # discard each input entry to allow accumulating output on "$@"
		if ! command -v "$util" > /dev/null 2>&1; then
			something_missing=yes
			set -- "$@" "$util" # accumulate missing utilities
		fi
	done
	if [ "$something_missing" ]; then
		printf %s\\n "$@"
		return 1
	fi
	return 0
)

# DOMAIN

usage()
(
	t='  '
	cat <<- EOF
		USAGE:
		${t}$(basename "$0") [OPTIONS] URL...

		DESCRIPTION:
		${t}Downloads music files for given URLs using yt-dlp.

		OPTIONS:
		${t}-h, --help
		${t}${t}Show this usage message.
		${t}-d, --directory=DIR
		${t}${t}A directory into which the outcome song file will be put.
		${t}${t}[default: $PWD]
		${t}-t, --timestamp=DATETIME
		${t}${t}A timestamp to be used for the song's filename prefix.
		${t}${t}[default: $(date +%Y%m%d)]
	EOF
)

# ENTRYPOINT

missing_utils=$(
	has_util getopt yt-dlp node
) || {
	echo "ERROR: missing necessary utilities:" $missing_utils >&2
	exit 1
}

if getopt --test > /dev/null 2>&1 && :; [ $? -ne 4 ]; then
	echo 'ERROR: Modern "getopt" utility required.' >&2
	exit 1
fi

args="$(
	getopt \
		--name "$(basename "$0")" \
		--options hid: \
		--longoptions help,directory: \
		-- "$@"
)" || exit 1
eval set -- "$args"

TARGET_DIR="$PWD"
while [ $# -gt 0 ]
do
	case "$1" in
		(--) shift; break ;;
		(-h|--help) usage; exit 0 ;;
		(-d|--directory) shift; TARGET_DIR="$1" ;;
		(-t|--timestamp) shift; timestamp="$1" ;;
		(*) shift ;;
	esac
done

cd "$TARGET_DIR"

for dl_url; do
	filepath_tmpfile="${TMPDIR:-$PWD}/yt-dlp-filepath-$$"
	: "${timestamp:="$(date +%Y%m%d)"}"

	tell_info downloading the file... >&2
	yt-dlp \
		--js-runtimes node \
		--audio-format opus \
		-x --embed-metadata --embed-thumbnail --embed-subs \
		-o "$timestamp--%(artist,album_artist,channel|unknown)#S--%(album|unknown)#S--%(track,title|unknown)#S.%(ext)#S" \
		--print-to-file after_move:filepath "$filepath_tmpfile" \
		-- "$dl_url" \
		>&2

		read -r filepath < "$filepath_tmpfile"
		rm -f "$filepath_tmpfile"

		new_filepath="$filepath"

		# Temporarily map replacements to percent-prefixed phrases:
		new_filepath="${new_filepath//%/%prcnt}"
		# For whitespace, yt-dlp uses underscores. Replace them with dashes:
		new_filepath="${new_filepath//_/%whspc}"
		new_filepath="${new_filepath//--/%ddash}"
		# Resolve percent-prefixed phrases:
		new_filepath="${new_filepath//%whspc/-}"
		new_filepath="${new_filepath//%ddash/_}"
		new_filepath="${new_filepath//%prcnt/%}"
		# Make the whole filename lowercase:
		new_filepath="${new_filepath,,}"

		tell_info tweaking the file name... >&2
		mv -vf "$filepath" "$new_filepath"

		touch "$new_filepath"

		tell_info done. >&2
	done
